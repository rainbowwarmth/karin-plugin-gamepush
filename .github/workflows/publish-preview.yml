# GitHub Actions å·¥ä½œæµï¼šå‘å¸ƒ Release PR é¢„è§ˆåŒ…
name: Publish Preview

# è§¦å‘æ¡ä»¶ï¼šPR æ‰“å¼€ã€åŒæ­¥ã€é‡æ–°æ‰“å¼€
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

# æƒé™é…ç½®ï¼šè¯»å–ä»£ç ï¼Œå†™å…¥ PR è¯„è®º
permissions:
  contents: read
  pull-requests: write

jobs:
  # é¢„è§ˆåŒ…å‘å¸ƒä»»åŠ¡
  preview:
    # è¿è¡Œç¯å¢ƒï¼šæœ€æ–° Ubuntu
    runs-on: ubuntu-latest
    # ä»…å¯¹æ ‡é¢˜ä»¥ 'chore(main): release' å¼€å¤´çš„ PR è§¦å‘
    if: startsWith(github.event.pull_request.title, 'chore(main): release')

    # ä»»åŠ¡æ­¥éª¤
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç ï¼ˆå®Œæ•´å†å²ï¼Œfetch-depth: 0ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½® Node.js 20 ç¯å¢ƒ
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # å¯é€‰ï¼šç¼“å­˜ npm ä¾èµ–ï¼Œæå‡æ„å»ºé€Ÿåº¦
          cache: 'npm'

      # 3. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: npm install

      # 4. ç”Ÿæˆéšæœºé¢„è§ˆç‰ˆæœ¬å·ï¼ˆåŸºäº package.json ç‰ˆæœ¬ + 8ä½éšæœºå­—ç¬¦ä¸²ï¼‰
      - name: Generate preview version
        run: |
          # è¯»å– package.json ä¸­çš„åŸºç¡€ç‰ˆæœ¬
          VERSION=$(jq -r .version package.json)
          # ç”Ÿæˆ 8 ä½å¤§å°å†™å­—æ¯+æ•°å­—éšæœºå­—ç¬¦ä¸²
          RANDOM_STR=$(node -e "const chars='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';let str='';for(let i=0;i<8;i++)str+=chars[Math.floor(Math.random()*chars.length)];console.log(str)")
          # æ‹¼æ¥é¢„è§ˆç‰ˆæœ¬å·ï¼ˆå¦‚ 1.0.0-a1b2c3d4ï¼‰
          PREVIEW_VERSION="${VERSION}-${RANDOM_STR}"
          # å°†ç‰ˆæœ¬å·å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PREVIEW_VERSION=$PREVIEW_VERSION" >> $GITHUB_ENV
          # æ›´æ–° package.json ç‰ˆæœ¬ï¼ˆä¸ç”Ÿæˆ git æ ‡ç­¾ï¼‰
          npm version "$PREVIEW_VERSION" --no-git-tag-version

      # 5. æ„å»ºé¡¹ç›®
      - name: Build project
        run: npm run build

      # 6. å‘å¸ƒé¢„è§ˆåŒ…åˆ° pkg.pr.new
      - name: Publish preview to pkg.pr.new
        id: pkgpr
        env:
          # æ³¨å…¥ GitHub å†…ç½® Tokenï¼Œç”¨äº pkg.pr.new è®¤è¯
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ‰§è¡Œå‘å¸ƒå‘½ä»¤ï¼Œå…³é—­é»˜è®¤è¯„è®ºï¼Œç´§å‡‘è¾“å‡º
          npx --yes pkg-pr-new publish --comment=off --compact > output.txt
          # ä»è¾“å‡ºä¸­æå–å®‰è£…é“¾æ¥
          INSTALL_URL=$(grep -oE 'https://pkg\.pr\.new/[^[:space:]`]+' output.txt | head -n 1)
          # å°†é“¾æ¥å­˜å…¥æ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­ PR è¯„è®ºä½¿ç”¨
          echo "install_url=$INSTALL_URL" >> $GITHUB_OUTPUT

      # 7. å‘ PR å†™å…¥/æ›´æ–°é¢„è§ˆåŒ…ä¿¡æ¯ï¼ˆè¦†ç›–å¼è¯„è®ºï¼‰
      - name: Comment preview info on PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          # è¯„è®ºå”¯ä¸€æ ‡ç­¾ï¼Œç”¨äºåç»­æ›´æ–°ï¼ˆé¿å…é‡å¤è¯„è®ºï¼‰
          comment-tag: release-preview
          # æ¨¡å¼ï¼šå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
          mode: upsert
          # ç»™è¯„è®ºæ·»åŠ  ğŸš€ è¡¨æƒ…
          reactions: rocket
          # è¯„è®ºå†…å®¹
          message: |
            ## ğŸš€ Release PR é¢„è§ˆåŒ…å·²å‘å¸ƒ

            ### é¢„è§ˆä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ env.PREVIEW_VERSION }}
            - **å®‰è£…å‘½ä»¤**: `npm i ${{ steps.pkgpr.outputs.install_url }}`

            ### å¿«é€Ÿå®‰è£…
            ```bash
            # å®‰è£…é¢„è§ˆåŒ…
            npm i ${{ steps.pkgpr.outputs.install_url }}

            # æˆ–æŒ‡å®šç‰ˆæœ¬å®‰è£…ï¼ˆå¦‚éœ€é”å®šç‰ˆæœ¬ï¼‰
            npm i your-package-name@${{ env.PREVIEW_VERSION }}
