name: Publish Preview # å‘å¸ƒé¢„è§ˆç‰ˆæœ¬çš„å·¥ä½œæµç¨‹åç§°

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write # éœ€è¦å†™æƒé™ä»¥ä¾¿è¯„è®º PR

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç ï¼ˆå®Œæ•´å†å²ï¼‰
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„ git å†å²ä»¥ä¾¿ç”Ÿæˆæ­£ç¡®çš„ç‰ˆæœ¬å·

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # å¯é€‰ï¼šç¼“å­˜ä¾èµ–ï¼Œæå‡é€Ÿåº¦

      # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ frozen-lockfile é”å®šç‰ˆæœ¬ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼‰
      - name: Install dependencies
        run: npm install --frozen-lockfile

      # ä¿®æ”¹ç‰ˆæœ¬å·ä¸ºé¢„è§ˆç‰ˆæœ¬ï¼ˆåŸºäº PR å· + çŸ­ SHAï¼Œä½¿ç”¨ PowerShell è„šæœ¬ï¼‰
      - name: Update version for preview
        run: |
          # è·å–å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬å·
          $currentVersion = (Get-Content package.json | ConvertFrom-Json).version
          # è·å– PR ç¼–å·
          $prNumber = "${{ github.event.pull_request.number }}"
          # è·å–æäº¤çš„çŸ­ SHAï¼ˆå‰ 7 ä½ï¼‰
          $shortSha = "${{ github.event.pull_request.head.sha }}".Substring(0, 7)
          # ç”Ÿæˆé¢„è§ˆç‰ˆæœ¬å·: æ ¼å¼ 1.0.0-pr.123.abc1234
          $previewVersion = "$currentVersion-pr.$prNumber.$shortSha"
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬å·ï¼ˆä¸ç”Ÿæˆ git æ ‡ç­¾ï¼‰
          npm version $previewVersion --no-git-tag-version
          # è¾“å‡ºç‰ˆæœ¬å·åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PREVIEW_VERSION=$previewVersion" >> $env:GITHUB_ENV
        shell: pwsh

      # ç¼–è¯‘é¡¹ç›®
      - name: Build
        run: npm run build

      # ä½¿ç”¨ pkg.pr.new å‘å¸ƒé¢„è§ˆç‰ˆæœ¬ï¼ˆæå– PNPM å®‰è£…å‘½ä»¤ï¼‰
      - name: Publish to pkg.pr.new
        id: pkg-pr-new
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ‰§è¡Œå‘å¸ƒå‘½ä»¤ï¼Œè¾“å‡º JSON æ—¥å¿—å¹¶å…³é—­é»˜è®¤è¯„è®ºï¼Œä½¿ç”¨ PNPM ä½œä¸ºåŒ…ç®¡ç†å™¨
          npx --yes pkg-pr-new publish --json output.json --comment=off --compact --packageManager=pnpm > pkg-output.txt 2>&1

          # ä»è¾“å‡ºæ—¥å¿—ä¸­æå–å®é™…çš„å®‰è£… URLï¼ˆå®¹é”™å¤„ç†ï¼šæœªæ‰¾åˆ°åˆ™è¿”å›ç©ºï¼‰
          ACTUAL_INSTALL_URL=$(grep -oE 'https://pkg\.pr\.new/[^[:space:]`]+' pkg-output.txt | head -n 1 || echo "")

          # æ„é€  PNPM å®‰è£…å‘½ä»¤ï¼ˆå¸¦ workspace æ ‡è¯†ï¼Œæœªæ‰¾åˆ° URL åˆ™æç¤ºé”™è¯¯ï¼‰
          if [ ! -z "$ACTUAL_INSTALL_URL" ]; then
            # ä¼˜åŒ–ï¼šæå–çŸ­é“¾æ¥æ ¼å¼ï¼Œç®€åŒ–å®‰è£…å‘½ä»¤
            if [[ "$ACTUAL_INSTALL_URL" =~ https://pkg\.pr\.new/[^/]+/[^/]+/([^/]+@.+) ]]; then
              ACTUAL_INSTALL_URL="https://pkg.pr.new/${BASH_REMATCH[1]}"
            fi
            PNPM_INSTALL_CMD="pnpm add ${ACTUAL_INSTALL_URL} -w"
          else
            PNPM_INSTALL_CMD="âŒ é¢„è§ˆåŒ…å‘å¸ƒå¤±è´¥ï¼Œæœªè·å–åˆ°å®‰è£…é“¾æ¥"
          fi

          # å°†å®‰è£…å‘½ä»¤å­˜å…¥æ­¥éª¤è¾“å‡ºï¼Œä¾›è¯„è®ºä½¿ç”¨
          echo "pnpm_install_cmd=$PNPM_INSTALL_CMD" >> $GITHUB_OUTPUT

      # åœ¨ PR ä¸­è¯„è®ºé¢„è§ˆç‰ˆæœ¬ä¿¡æ¯ï¼ˆè¦†ç›–å¼æ›´æ–°ï¼‰
      - name: Comment preview info
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: published-packages # å”¯ä¸€æ ‡ç­¾ï¼Œç”¨äºæ›´æ–°è¯„è®º
          mode: upsert # å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
          reactions: rocket # è¯„è®ºæ·»åŠ  ğŸš€ è¡¨æƒ…
          message: |
            ## ğŸš€ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ

            ### ğŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬:** `${{ env.PREVIEW_VERSION }}`
            - **æäº¤:** [`${{ github.event.pull_request.head.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.event.pull_request.head.sha }})
            - **PR ç¼–å·:** #${{ github.event.pull_request.number }}

            ### ğŸ“¥ å®‰è£…å‘½ä»¤
            ```bash
            ${{ steps.pkg-pr-new.outputs.pnpm_install_cmd }}
